<div class="overflow-x-auto">
    <table class="table table-zebra">
        <thead>
            <tr>
                <th>
                    <label>
                        <input type="checkbox"
                               class="checkbox checkbox-sm"
                               id="select-all"
                               onchange="toggleSelectAll(this)">
                    </label>
                </th>
                <th>Uczeń</th>
                <th>Klasa</th>
                <th>Status</th>
                <th>Akcje</th>
            </tr>
        </thead>
        <tbody>
            {% for ls in students %}
            <tr>
                <td>
                    <label>
                        <input type="checkbox"
                               class="checkbox checkbox-sm student-checkbox"
                               value="{{ ls.student.id }}"
                               onchange="updateBulkActions()">
                    </label>
                </td>
                <td>
                    <div>
                        <div class="font-medium">{{ ls.student.get_full_name }}</div>
                        <div class="text-sm text-base-content/60">{{ ls.student.email }}</div>
                    </div>
                </td>
                <td>
                    {% if ls.student.student_profile %}
                        {{ ls.student.student_profile.class_name|default:"N/A" }}
                    {% else %}
                        N/A
                    {% endif %}
                </td>
                <td>
                    {% include "attendance/partials/_status_badge.html" with status=ls.attendance_status student_id=ls.student.id %}
                </td>
                <td>
                    <div class="flex gap-1">
                        <button class="btn btn-xs btn-success"
                                hx-post="{% url 'attendance:mark' lesson.pk %}"
                                hx-vals='{"student_id": "{{ ls.student.id }}", "status": "PRESENT"}'
                                hx-target="#status-{{ ls.student.id }}"
                                hx-swap="outerHTML">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                        </button>
                        <button class="btn btn-xs btn-error"
                                hx-post="{% url 'attendance:mark' lesson.pk %}"
                                hx-vals='{"student_id": "{{ ls.student.id }}", "status": "ABSENT"}'
                                hx-target="#status-{{ ls.student.id }}"
                                hx-swap="outerHTML">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                        <button class="btn btn-xs btn-warning"
                                hx-post="{% url 'attendance:mark' lesson.pk %}"
                                hx-vals='{"student_id": "{{ ls.student.id }}", "status": "LATE"}'
                                hx-target="#status-{{ ls.student.id }}"
                                hx-swap="outerHTML">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Bulk Actions Bar (shown when items selected) -->
<div id="bulk-actions" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 bg-primary text-primary-content rounded-lg shadow-lg p-4 flex items-center gap-4">
    <span id="selected-count">0</span> zaznaczonych
    <div class="flex gap-2">
        <button class="btn btn-sm btn-success" onclick="bulkMark('PRESENT')">Obecni</button>
        <button class="btn btn-sm btn-error" onclick="bulkMark('ABSENT')">Nieobecni</button>
        <button class="btn btn-sm btn-warning" onclick="bulkMark('LATE')">Spóźnieni</button>
    </div>
</div>

<script>
function toggleSelectAll(checkbox) {
    document.querySelectorAll('.student-checkbox').forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateBulkActions();
}

function updateBulkActions() {
    const checked = document.querySelectorAll('.student-checkbox:checked');
    const bulkBar = document.getElementById('bulk-actions');
    const countSpan = document.getElementById('selected-count');

    if (checked.length > 0) {
        bulkBar.classList.remove('hidden');
        countSpan.textContent = checked.length;
    } else {
        bulkBar.classList.add('hidden');
    }
}

function bulkMark(status) {
    const checked = document.querySelectorAll('.student-checkbox:checked');
    const studentIds = Array.from(checked).map(cb => cb.value);

    // Send bulk update via HTMX
    htmx.ajax('POST', '{% url "attendance:bulk_mark" lesson.pk %}', {
        values: {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            ...Object.fromEntries(studentIds.map(id => [`status_${id}`, status]))
        }
    });
}
</script>
