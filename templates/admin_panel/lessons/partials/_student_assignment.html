<div class="space-y-4" x-data="studentAssignment()">
    <div class="flex items-center justify-between">
        <label class="label">
            <span class="label-text font-medium">Przypisani uczniowie *</span>
        </label>
        <div class="badge" :class="isFull ? 'badge-error' : 'badge-secondary'">
            <span x-text="selectedCount"></span>
            <template x-if="isGroupLesson && maxParticipants">
                <span> / <span x-text="maxParticipants"></span></span>
            </template>
        </div>
    </div>

    <!-- Search Input -->
    <div class="form-control">
        <input type="text"
               x-model="searchQuery"
               class="input input-bordered w-full"
               placeholder="Szukaj ucznia...">
    </div>

    <!-- Student List -->
    <div class="border rounded-lg max-h-64 overflow-y-auto">
        <template x-for="student in filteredStudents" :key="student.id">
            <label class="flex items-center justify-between p-3 hover:bg-base-200 cursor-pointer border-b last:border-b-0"
                   :class="{ 'bg-error/10': student.hasConflict }">
                <div class="flex items-center space-x-3">
                    <input type="checkbox"
                           name="students"
                           :value="student.id"
                           :checked="isSelected(student.id)"
                           :disabled="!isSelected(student.id) && isFull"
                           @change="toggleStudent(student.id)"
                           class="checkbox checkbox-sm">
                    <div>
                        <div class="font-medium" x-text="student.name"></div>
                        <div class="text-xs text-base-content/60" x-text="student.className"></div>
                    </div>
                </div>
                <template x-if="student.hasConflict">
                    <span class="badge badge-warning badge-sm">Konflikt</span>
                </template>
            </label>
        </template>
    </div>

    <!-- Selected Students Display -->
    <template x-if="selectedStudents.length > 0">
        <div class="flex flex-wrap gap-2">
            <template x-for="student in selectedStudents" :key="student.id">
                <span class="badge badge-lg gap-1"
                      :class="student.hasConflict ? 'badge-warning' : 'badge-primary'">
                    <span x-text="student.name"></span>
                    <button type="button" @click="toggleStudent(student.id)" class="hover:text-error">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </span>
            </template>
        </div>
    </template>

    <!-- Conflict Warning -->
    <template x-if="conflictCount > 0">
        <div class="alert alert-warning">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <span x-text="`${conflictCount} uczen(ow) ma konflikt z innymi zajeciami`"></span>
        </div>
    </template>
</div>

<script>
function studentAssignment() {
    return {
        students: {{ students_json|safe }},
        selectedIds: {{ selected_students_json|safe }},
        isGroupLesson: {{ is_group_lesson|yesno:'true,false' }},
        maxParticipants: {{ max_participants|default:0 }},
        searchQuery: '',
        conflicts: [],

        get selectedCount() {
            return this.selectedIds.length;
        },

        get isFull() {
            if (!this.isGroupLesson || !this.maxParticipants) return false;
            return this.selectedIds.length >= this.maxParticipants;
        },

        get filteredStudents() {
            if (!this.searchQuery) return this.students;
            const query = this.searchQuery.toLowerCase();
            return this.students.filter(s =>
                s.name.toLowerCase().includes(query)
            );
        },

        get selectedStudents() {
            return this.students.filter(s => this.selectedIds.includes(s.id));
        },

        get conflictCount() {
            return this.selectedStudents.filter(s => s.hasConflict).length;
        },

        isSelected(id) {
            return this.selectedIds.includes(id);
        },

        toggleStudent(id) {
            const index = this.selectedIds.indexOf(id);
            if (index > -1) {
                this.selectedIds.splice(index, 1);
            } else if (!this.isFull) {
                this.selectedIds.push(id);
            }
        },

        async checkConflicts() {
            const startTime = document.querySelector('[name="start_time"]')?.value;
            const endTime = document.querySelector('[name="end_time"]')?.value;

            if (!startTime || !endTime) return;

            for (const id of this.selectedIds) {
                const response = await fetch(`/api/students/${id}/check-availability/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                    body: JSON.stringify({ start_time: startTime, end_time: endTime })
                });
                const data = await response.json();
                const student = this.students.find(s => s.id === id);
                if (student) {
                    student.hasConflict = !data.available;
                }
            }
        },

        init() {
            const startInput = document.querySelector('[name="start_time"]');
            const endInput = document.querySelector('[name="end_time"]');

            if (startInput) startInput.addEventListener('change', () => this.checkConflicts());
            if (endInput) endInput.addEventListener('change', () => this.checkConflicts());
        }
    };
}
</script>
