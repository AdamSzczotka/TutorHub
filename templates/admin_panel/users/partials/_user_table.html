{% if users %}
<div x-data="{ selectedUsers: [], selectAll: false }"
     x-init="$watch('selectAll', value => {
         selectedUsers = value ? [...document.querySelectorAll('[name=user_ids]')].map(el => el.value) : []
     })">

    <!-- Bulk Action Bar -->
    <div class="bg-base-200 p-4 rounded-lg mb-4"
         x-show="selectedUsers.length > 0"
         x-transition>
        <form method="post" action="{% url 'accounts:user-bulk-action' %}">
            {% csrf_token %}

            <template x-for="id in selectedUsers" :key="id">
                <input type="hidden" name="user_ids" :value="id">
            </template>

            <div class="flex items-center gap-4">
                <span class="font-medium">
                    Wybrano: <span x-text="selectedUsers.length"></span> użytkowników
                </span>

                <select name="action" class="select select-bordered select-sm">
                    <option value="">Wybierz akcję...</option>
                    <option value="activate">Aktywuj</option>
                    <option value="deactivate">Dezaktywuj</option>
                    <option value="send_password_reset">Wyślij reset hasła</option>
                    <option value="export">Eksportuj do CSV</option>
                    <option value="delete">Usuń</option>
                </select>

                <button type="submit" class="btn btn-primary btn-sm">
                    Wykonaj
                </button>

                <button type="button"
                        class="btn btn-ghost btn-sm"
                        @click="selectedUsers = []; selectAll = false">
                    Anuluj
                </button>
            </div>
        </form>
    </div>

    <div class="overflow-x-auto">
        <table class="table table-zebra">
            <thead>
                <tr>
                    <th>
                        <input type="checkbox" class="checkbox checkbox-sm"
                               x-model="selectAll">
                    </th>
                    <th>Użytkownik</th>
                    <th>Email</th>
                    <th>Rola</th>
                    <th>Status</th>
                    <th>Profil</th>
                    <th>Data rejestracji</th>
                    <th>Akcje</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>
                        <input type="checkbox"
                               name="user_ids"
                               value="{{ user.pk }}"
                               class="checkbox checkbox-sm"
                               @click="selectedUsers.includes('{{ user.pk }}') ? selectedUsers = selectedUsers.filter(id => id !== '{{ user.pk }}') : selectedUsers.push('{{ user.pk }}')"
                               :checked="selectedUsers.includes('{{ user.pk }}')">
                    </td>
                    <td>
                        <div class="flex items-center gap-3">
                            <div class="avatar placeholder">
                                <div class="bg-neutral text-neutral-content rounded-full w-10">
                                    {% if user.avatar %}
                                        <img src="{{ user.avatar.url }}" alt="Avatar użytkownika {{ user.get_full_name }}">
                                    {% else %}
                                        <span>{{ user.first_name.0 }}{{ user.last_name.0 }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div>
                                <div class="font-bold">{{ user.get_full_name }}</div>
                                <div class="text-sm opacity-50">{{ user.phone|default:"-" }}</div>
                            </div>
                        </div>
                    </td>
                    <td>{{ user.email }}</td>
                    <td>
                        {% if user.role == 'admin' %}
                            <span class="badge badge-primary">Administrator</span>
                        {% elif user.role == 'tutor' %}
                            <span class="badge badge-secondary">Korepetytor</span>
                        {% else %}
                            <span class="badge badge-accent">Uczeń</span>
                        {% endif %}
                    </td>
                    <td>
                        <button type="button"
                                hx-post="{% url 'accounts:user-toggle-status' user.pk %}"
                                hx-swap="outerHTML"
                                class="badge {% if user.is_active %}badge-success{% else %}badge-error{% endif %} cursor-pointer hover:opacity-80 focus:outline focus:outline-2 focus:outline-offset-2 focus:outline-primary"
                                title="Kliknij aby zmienić status"
                                aria-pressed="{{ user.is_active|yesno:'true,false' }}">
                            {% if user.is_active %}aktywny{% else %}nieaktywny{% endif %}
                        </button>
                    </td>
                    <td>
                        {% if user.is_profile_completed %}
                            <span class="badge badge-success">Uzupełniony</span>
                        {% else %}
                            <span class="badge badge-warning">Niekompletny</span>
                        {% endif %}
                    </td>
                    <td>{{ user.date_joined|date:"d.m.Y H:i" }}</td>
                    <td>
                        <div class="flex gap-1">
                            <a href="{% url 'accounts:user-detail' user.pk %}"
                               class="btn btn-ghost btn-xs"
                               title="Szczegóły">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                            </a>
                            <a href="{% url 'accounts:user-update' user.pk %}"
                               class="btn btn-ghost btn-xs"
                               title="Edytuj">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </a>
                            <a href="{% url 'accounts:user-delete' user.pk %}"
                               class="btn btn-ghost btn-xs text-error"
                               title="Usuń">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

<!-- Pagination -->
{% if page_obj.has_other_pages %}
<div class="flex justify-center mt-4">
    <div class="join">
        {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.role %}&role={{ request.GET.role }}{% endif %}{% if request.GET.is_active %}&is_active={{ request.GET.is_active }}{% endif %}{% if request.GET.is_profile_completed %}&is_profile_completed={{ request.GET.is_profile_completed }}{% endif %}"
               class="join-item btn"
               hx-get="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.role %}&role={{ request.GET.role }}{% endif %}{% if request.GET.is_active %}&is_active={{ request.GET.is_active }}{% endif %}{% if request.GET.is_profile_completed %}&is_profile_completed={{ request.GET.is_profile_completed }}{% endif %}"
               hx-target="#user-table"
               hx-swap="innerHTML">
                &laquo;
            </a>
        {% endif %}

        <span class="join-item btn btn-disabled">
            Strona {{ page_obj.number }} z {{ page_obj.paginator.num_pages }}
        </span>

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.role %}&role={{ request.GET.role }}{% endif %}{% if request.GET.is_active %}&is_active={{ request.GET.is_active }}{% endif %}{% if request.GET.is_profile_completed %}&is_profile_completed={{ request.GET.is_profile_completed }}{% endif %}"
               class="join-item btn"
               hx-get="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.role %}&role={{ request.GET.role }}{% endif %}{% if request.GET.is_active %}&is_active={{ request.GET.is_active }}{% endif %}{% if request.GET.is_profile_completed %}&is_profile_completed={{ request.GET.is_profile_completed }}{% endif %}"
               hx-target="#user-table"
               hx-swap="innerHTML">
                &raquo;
            </a>
        {% endif %}
    </div>
</div>
{% endif %}
</div>
{% else %}
{% include "partials/_empty.html" with message="Brak użytkowników" description="Dodaj pierwszego użytkownika do systemu." action_url="accounts:user-create" action_text="Dodaj użytkownika" %}
{% endif %}
