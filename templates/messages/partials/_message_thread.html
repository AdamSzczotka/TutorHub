{% load humanize %}

<div class="flex flex-col h-[calc(100vh-280px)]">
    <!-- Messages -->
    <div id="message-thread"
         class="flex-1 overflow-y-auto p-4 space-y-4 bg-base-200/50"
         x-data="{
             scrollToBottom() { this.$el.scrollTop = this.$el.scrollHeight },
             wasAtBottom: true,
             checkScroll() {
                 this.wasAtBottom = (this.$el.scrollHeight - this.$el.scrollTop - this.$el.clientHeight) < 50;
             },
             maybeScroll() {
                 if (this.wasAtBottom) this.scrollToBottom();
             }
         }"
         x-init="scrollToBottom()"
         @scroll="checkScroll()"
         hx-trigger="every 5s, messageSent from:body"
         hx-get="{% url 'messages:detail' conversation.id %}"
         hx-select="#message-thread"
         hx-swap="outerHTML settle:0ms"
         hx-on::after-swap="$el.__x.$data.maybeScroll()">

        {% regroup messages_list by created_at.date as messages_by_date %}
        {% for date_group in messages_by_date %}
        <div class="flex items-center justify-center my-4">
            <span class="bg-base-100 border rounded-full px-3 py-1 text-xs text-gray-600">
                {{ date_group.grouper|date:"d F Y" }}
            </span>
        </div>

        {% for message in date_group.list %}
        {% include "messages/partials/_message_bubble.html" with message=message current_user=request.user %}
        {% endfor %}
        {% empty %}
        <div class="text-center py-8 text-gray-500">
            <p>Brak wiadomości. Rozpocznij rozmowę!</p>
        </div>
        {% endfor %}
    </div>

    <!-- Composer -->
    <div class="border-t bg-base-100 p-4"
         x-data="{ content: '', replyTo: null }">

        <!-- Reply indicator -->
        <template x-if="replyTo">
            <div class="bg-primary/10 border border-primary/20 rounded-lg p-3 mb-3 flex items-start justify-between">
                <div>
                    <div class="text-xs font-medium text-primary">
                        Odpowiedź do <span x-text="replyTo.senderName"></span>
                    </div>
                    <div class="text-sm text-gray-600 mt-1 line-clamp-2" x-text="replyTo.content"></div>
                </div>
                <button type="button"
                        class="btn btn-ghost btn-xs"
                        @click="replyTo = null">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </template>

        <form hx-post="{% url 'messages:send' conversation.id %}"
              hx-target="#message-thread"
              hx-swap="beforeend"
              hx-on::after-request="this.reset(); $dispatch('message-sent')"
              enctype="multipart/form-data"
              class="space-y-3"
              @message-sent.window="content = ''; replyTo = null">
            {% csrf_token %}

            <textarea name="content"
                      x-model="content"
                      class="textarea textarea-bordered w-full resize-none"
                      rows="3"
                      placeholder="Wpisz wiadomość..."
                      @keydown.ctrl.enter="$refs.submitBtn.click()"></textarea>

            <input type="hidden" name="reply_to" :value="replyTo?.id">

            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <input type="file"
                           name="attachments"
                           id="file-upload"
                           multiple
                           accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt,.zip,.rar"
                           class="hidden">
                    <label for="file-upload" class="btn btn-outline btn-sm">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                        </svg>
                        Załącz
                    </label>
                </div>

                <button type="submit"
                        x-ref="submitBtn"
                        class="btn btn-primary"
                        :disabled="!content.trim()">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                    Wyślij
                </button>
            </div>
        </form>
    </div>
</div>
