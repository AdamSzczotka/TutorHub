{% load humanize %}

<div class="flex items-start gap-2 group {% if message.sender == current_user %}flex-row-reverse{% endif %}"
     id="message-{{ message.id }}">

    <!-- Avatar -->
    <div class="avatar placeholder">
        <div class="w-8 h-8 rounded-full {% if message.sender.avatar %}{% else %}bg-neutral text-neutral-content{% endif %}">
            {% if message.sender.avatar %}
            <img src="{{ message.sender.avatar.url }}" alt="{{ message.sender.get_full_name }}">
            {% else %}
            <span class="text-xs font-bold">
                {{ message.sender.first_name.0 }}{{ message.sender.last_name.0 }}
            </span>
            {% endif %}
        </div>
    </div>

    <!-- Message content -->
    <div class="flex-1 max-w-[70%] space-y-1 {% if message.sender == current_user %}flex flex-col items-end{% endif %}">
        <div class="rounded-lg px-4 py-2 {% if message.sender == current_user %}bg-primary text-primary-content{% else %}bg-base-100 text-base-content shadow{% endif %}">

            {% if message.sender != current_user %}
            <div class="text-xs font-medium mb-1 opacity-75">
                {{ message.sender.get_full_name }}
            </div>
            {% endif %}

            {% if message.reply_to %}
            <div class="bg-black/10 rounded px-2 py-1 mb-2 text-xs">
                <div class="font-medium">
                    {{ message.reply_to.sender.get_full_name }}
                </div>
                <div class="line-clamp-2 opacity-75">
                    {{ message.reply_to.content|striptags|truncatewords:15 }}
                </div>
            </div>
            {% endif %}

            <div class="prose prose-sm max-w-none {% if message.sender == current_user %}prose-invert{% endif %}">
                {{ message.content|linebreaks }}
            </div>

            {% if message.attachments.exists %}
            <div class="mt-2 space-y-1">
                {% for attachment in message.attachments.all %}
                <a href="{{ attachment.file.url }}"
                   target="_blank"
                   class="block bg-black/10 rounded px-2 py-1 text-xs hover:bg-black/20 transition-colors">
                    <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                    </svg>
                    {{ attachment.file_name }} ({{ attachment.file_size|filesizeformat }})
                </a>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="flex items-center gap-2 text-xs text-gray-500 {% if message.sender == current_user %}flex-row-reverse{% endif %}">
            <span>{{ message.created_at|time:"H:i" }}</span>
            {% if message.is_edited %}
            <span class="opacity-75">(edytowano)</span>
            {% endif %}
            {% if message.sender == current_user %}
            <span>
                {% if message.read_receipts.count > 1 %}
                <!-- Double check - read -->
                <svg class="w-4 h-4 text-primary inline" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>
                <svg class="w-4 h-4 text-primary inline -ml-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>
                {% else %}
                <!-- Single check - sent -->
                <svg class="w-4 h-4 inline" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>
                {% endif %}
            </span>
            {% endif %}
        </div>
    </div>

    <!-- Actions dropdown -->
    <div class="dropdown dropdown-end opacity-0 group-hover:opacity-100 transition-opacity">
        <label tabindex="0" class="btn btn-ghost btn-xs">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
            </svg>
        </label>
        <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-40 z-10">
            <li>
                <button @click="$dispatch('set-reply', {
                    id: '{{ message.id }}',
                    content: '{{ message.content|truncatewords:10|escapejs }}',
                    senderName: '{{ message.sender.get_full_name|escapejs }}'
                })"
                x-on:set-reply.window="replyTo = $event.detail">
                    Odpowiedz
                </button>
            </li>
            {% if message.sender == current_user %}
            <li>
                <button hx-get="{% url 'messages:edit' message.id %}"
                        hx-target="#message-{{ message.id }}"
                        hx-swap="outerHTML">
                    Edytuj
                </button>
            </li>
            <li>
                <button hx-delete="{% url 'messages:delete' message.id %}"
                        hx-confirm="Czy na pewno chcesz usunąć tę wiadomość?"
                        hx-target="#message-{{ message.id }}"
                        hx-swap="delete"
                        class="text-error">
                    Usuń
                </button>
            </li>
            {% endif %}
        </ul>
    </div>
</div>
